// Top of JS file — Global data
const data = {
  "questions": [
    {
      "id": 1,
      "title": "Valid Palindrome",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/valid-palindrome/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["google.png", "amazon.jpeg", "microsoft.png"]
    },
    {
      "id": 2,
      "title": "Reverse String",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/reverse-string/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["amazon.jpeg", "microsoft.png"]
    },
    {
      "id": 3,
      "title": "First Unique Character in a String",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/first-unique-character-in-a-string/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["google.png", "amazon.jpeg"]
    },
    {
      "id": 4,
      "title": "Valid Anagram",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/valid-anagram/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["google.png", "amazon.jpeg", "microsoft.png"]
    },
    {
      "id": 5,
      "title": "Longest Common Prefix",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/longest-common-prefix/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["amazon.jpeg", "google.png"]
    },
    {
      "id": 6,
      "title": "Reverse Vowels of a String",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/reverse-vowels-of-a-string/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["microsoft.png", "amazon.jpeg"]
    },
    {
      "id": 7,
      "title": "Ransom Note",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/ransom-note/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["google.png", "microsoft.png"]
    },
    {
      "id": 8,
      "title": "Valid Parentheses",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/valid-parentheses/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["google.png", "amazon.jpeg", "microsoft.png"]
    },
    {
      "id": 9,
      "title": "Implement strStr()",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/implement-strstr/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["amazon.jpeg", "microsoft.png"]
    },
    {
      "id": 10,
      "title": "Count and Say",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/count-and-say/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["google.png", "Capgemini.png"]
    },
    {
      "id": 11,
      "title": "Length of Last Word",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/length-of-last-word/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["microsoft.png", "amazon.jpeg"]
    },
    {
      "id": 12,
      "title": "Roman to Integer",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/roman-to-integer/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["google.png", "amazon.jpeg"]
    },
    {
      "id": 13,
      "title": "String to Integer (atoi)",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/string-to-integer-atoi/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["microsoft.png", "google.png"]
    },
    {
      "id": 14,
      "title": "Reverse Words in a String",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/reverse-words-in-a-string/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["amazon.jpeg", "microsoft.png"]
    },
    {
      "id": 15,
      "title": "Valid Palindrome II",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/valid-palindrome-ii/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["google.png", "amazon.jpeg"]
    },
    {
      "id": 16,
      "title": "Isomorphic Strings",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/isomorphic-strings/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["microsoft.png", "google.png"]
    },
    {
      "id": 17,
      "title": "Add Binary",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/add-binary/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["amazon.jpeg", "google.png"]
    },
    {
      "id": 18,
      "title": "Longest Palindrome",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/longest-palindrome/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["microsoft.png", "netflix.png"]
    },
    {
      "id": 19,
      "title": "Student Attendance Record I",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/student-attendance-record-i/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["google.png", "Capgemini.png"]
    },
    {
      "id": 20,
      "title": "Robot Return to Origin",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/robot-return-to-origin/",
      "practiceSite": "leetcode.png",
      "status": "Untouched",
      "companies": ["amazon.jpeg", "microsoft.png"]
    }
  ]
};
// Make sure this runs AFTER DOM is loaded
document.addEventListener("DOMContentLoaded", function () {
  // Initialize pagination and render first page
  renderPagination();
  goToPage(1);
  initializeTableFunctionality();
});

// Helper function to get paginated questions
function getPaginatedQuestions(pageNumber) {
  const questionsPerPage = 5;
  const startIndex = (pageNumber - 1) * questionsPerPage;
  const endIndex = startIndex + questionsPerPage;
  return data.questions.slice(startIndex, endIndex);
}

function renderTable(questions) {
  const tbody = document.querySelector('.table tbody');
  tbody.innerHTML = ''; // Clear existing rows

  questions.forEach((question, index) => {
      const row = document.createElement('tr');
      if (index % 2 === 1) row.style.backgroundColor = '#f9f9f9'; // Alternate row colors

      row.innerHTML =
          '<td style="width: 0px">' +
          '<div class="form-check">' +
          '<input class="form-check-input review-checkbox" type="checkbox" id="check-' + question.id + '">' +
          '<label class="form-check-label" for="check-' + question.id + '"></label>' +
          '</div>' +
          '</td>' +
          '<td>' +
          '<div class="d-flex align-items-center">' +
          '<div class="ms-4">' +
          '<div>' + question.title + '</div>' +
          '</div>' +
          '</div>' +
          '</td>' +
          '<td>' +
          '<div class="avatar-group">' +
          question.languages.map(function (lang) {
              return '<div class="avatar avatar-xs">' +
                  '<img class="avatar-img" src="' + lang.toLowerCase() + '.png" alt="' + lang + '">' +
                  '</div>';
          }).join('') +
          '</div>' +
          '</td>' +
          '<td>' +
          '<div class="avatar-group">' +
          '<div class="avatar avatar-xs" style="margin-left: 1.2vw;">' +
          '<a href="' + question.practiceLink + '">' +
          '<img class="avatar-img" src="' + question.practiceSite + '" alt="Practice site" style="' + (question.practiceSite === 'gfg.png' ? 'width: 39px; height: 23px;' : '') + '">' +
          '</a>' +
          '</div>' +
          '</div>' +
          '</td>' +
          '<td>' +
          '<select class="form-select form-select-sm border-0 status-select text-danger" style="width: auto;" data-review-link="' + question.practiceLink + '">' +
          '<option class="text-danger" value="Untouched"' + (question.status === 'Untouched' ? ' selected' : '') + '>Untouched</option>' +
          '<option class="text-warning" value="In Progress"' + (question.status === 'In Progress' ? ' selected' : '') + '>In Progress</option>' +
          '<option class="text-success" value="Completed"' + (question.status === 'Completed' ? ' selected' : '') + '>Completed</option>' +
          '<option class="text-primary" value="Review"' + (question.status === 'Review' ? ' selected' : '') + '>Review</option>' +
          '</select>' +
          '</td>' +
          '<td>' +
          '<div class="avatar-group">' +
          question.companies.map(function (company) {
              return '<div class="avatar avatar-xs">' +
                  '<img class="avatar-img" src="' + company + '" alt="' + company.split('.')[0] + '">' +
                  '</div>';
          }).join('') +
          '</div>' +
          '</td>';

      tbody.appendChild(row);
  });
}

function renderPagination() {
  const paginationContainer = document.querySelector('.pagination');
  const questionsPerPage = 5;
  const totalPages = Math.ceil(data.questions.length / questionsPerPage);

  paginationContainer.innerHTML = '';

  // Previous button
  const prevItem = document.createElement('li');
  prevItem.className = 'page-item';
  prevItem.innerHTML = `
      <a class="page-link" href="#" aria-label="Previous">
          <span aria-hidden="true">«</span>
      </a>
  `;
  prevItem.addEventListener('click', (e) => {
      e.preventDefault();
      const currentActive = document.querySelector('.pagination .active');
      const currentPage = currentActive ? parseInt(currentActive.textContent) : 1;
      if (currentPage > 1) {
          goToPage(currentPage - 1);
      }
  });
  paginationContainer.appendChild(prevItem);

  // Page numbers
  for (let i = 1; i <= totalPages; i++) {
      const pageItem = document.createElement('li');
      pageItem.className = 'page-item';
      if (i === 1) pageItem.classList.add('active');

      const pageLink = document.createElement('a');
      pageLink.className = 'page-link';
      pageLink.href = '#';
      pageLink.textContent = i;

      pageLink.addEventListener('click', (e) => {
          e.preventDefault();
          goToPage(i);
      });

      pageItem.appendChild(pageLink);
      paginationContainer.appendChild(pageItem);
  }

  // Next button
  const nextItem = document.createElement('li');
  nextItem.className = 'page-item';
  nextItem.innerHTML = `
      <a class="page-link" href="#" aria-label="Next">
          <span aria-hidden="true">»</span>
      </a>
  `;
  nextItem.addEventListener('click', (e) => {
      e.preventDefault();
      const currentActive = document.querySelector('.pagination .active');
      const currentPage = currentActive ? parseInt(currentActive.textContent) : 1;
      if (currentPage < totalPages) {
          goToPage(currentPage + 1);
      }
  });
  paginationContainer.appendChild(nextItem);
}

function goToPage(pageNumber) {
  const questions = getPaginatedQuestions(pageNumber);
  renderTable(questions);
  updateActivePage(pageNumber);
  initializeTableFunctionality(); // Reinitialize functionality for new rows
}

function updateActivePage(newActivePage) {
  const pageItems = document.querySelectorAll('.pagination .page-item');
  pageItems.forEach((item, index) => {
      // Skip prev/next buttons (first and last elements)
      if (index > 0 && index < pageItems.length - 1) {
          item.classList.remove('active');
          if (index === newActivePage) {
              item.classList.add('active');
          }
      }
  });
}

function initializeTableFunctionality() {
  const completedCountElement = document.getElementById('completedCount');
  const searchInput = document.getElementById('questionSearch');

  function updateCompletedCount() {
      const statusDropdowns = document.querySelectorAll('.status-select');
      const completedCount = Array.from(statusDropdowns).filter(function (select) {
          return select.value === 'Completed';
      }).length;
      completedCountElement.textContent = completedCount + ' out of ' + statusDropdowns.length + ' programs completed';
  }

  function applyColorClass(select) {
      select.classList.remove('text-danger', 'text-warning', 'text-success', 'text-primary');
      switch (select.value) {
          case 'Untouched': select.classList.add('text-danger'); break;
          case 'In Progress': select.classList.add('text-warning'); break;
          case 'Completed': select.classList.add('text-success'); break;
          case 'Review': select.classList.add('text-primary'); break;
      }
  }

  function handleStatusChange(select, index) {
      const value = select.value;
      const checkboxes = document.querySelectorAll('.review-checkbox');
      const checkbox = checkboxes[index];

      checkbox.checked = (value === 'Completed' || value === 'Review');

      updateCompletedCount();
      applyColorClass(select);

      if (value === 'Review') {
          const reviewLink = select.getAttribute('data-review-link');
          if (reviewLink) window.open(reviewLink, '_blank');
      }
  }

  const statusDropdowns = document.querySelectorAll('.status-select');
  const checkboxes = document.querySelectorAll('.review-checkbox');
  statusDropdowns.forEach(function (select, index) {
      applyColorClass(select);
      if (select.value === 'Completed' || select.value === 'Review') checkboxes[index].checked = true;
      select.addEventListener('change', function () {
          handleStatusChange(select, index);
      });
  });

  updateCompletedCount();

  if (searchInput) {
      searchInput.addEventListener('input', function () {
          const searchTerm = this.value.toLowerCase();
          const tableRows = document.querySelectorAll('.table tbody tr');

          tableRows.forEach(function (row) {
              const questionCell = row.cells[1];
              const titleDiv = questionCell.querySelector('div.ms-4 > div');
              const questionText = titleDiv ? titleDiv.textContent.toLowerCase() : "";

              const statusSelect = row.querySelector('.status-select');
              const statusText = statusSelect ? statusSelect.value.toLowerCase() : "";

              const companyCell = row.cells[row.cells.length - 1];
              const companyImgs = companyCell ? companyCell.querySelectorAll('img') : [];
              let companyMatch = false;

              companyImgs.forEach(function (img) {
                  const src = img.getAttribute('src').toLowerCase();
                  if (src.includes(searchTerm)) companyMatch = true;
              });

              const matches = questionText.includes(searchTerm) || statusText.includes(searchTerm) || companyMatch;
              row.style.display = matches ? '' : 'none';
          });
      });
  }
}
