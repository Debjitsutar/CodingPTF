// Top of JS file — Global data
const data = {
    "questions": [
      {
        "id": 1,
        "title": "Construct Binary Tree from Preorder and Inorder Traversal",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/construct-binary-tree-from-preorder-and-inorder-traversal/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png", "amazon.jpeg", "microsoft.png"]
      },
      {
        "id": 2,
        "title": "Validate Binary Search Tree",
        "languages": ["Java", "C++", "Python", "C"],
        "practiceLink": "https://leetcode.com/problems/validate-binary-search-tree/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["microsoft.png", "amazon.jpeg", "google.png"]
      },
      {
        "id": 3,
        "title": "Binary Tree Zigzag Level Order Traversal",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/binary-tree-zigzag-level-order-traversal/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["amazon.jpeg", "google.png", "microsoft.png"]
      },
      {
        "id": 4,
        "title": "Lowest Common Ancestor of a Binary Tree",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/lowest-common-ancestor-of-a-binary-tree/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png", "amazon.jpeg", "netflix.png"]
      },
      {
        "id": 5,
        "title": "Binary Tree Right Side View",
        "languages": ["C++", "Python", "Java"],
        "practiceLink": "https://leetcode.com/problems/binary-tree-right-side-view/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["microsoft.png", "amazon.jpeg", "google.png"]
      },
      {
        "id": 6,
        "title": "Kth Smallest Element in a BST",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/kth-smallest-element-in-a-bst/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png", "amazon.jpeg"]
      },
      {
        "id": 7,
        "title": "Serialize and Deserialize Binary Tree",
        "languages": ["Java", "Python", "C++"],
        "practiceLink": "https://leetcode.com/problems/serialize-and-deserialize-binary-tree/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["microsoft.png", "amazon.jpeg"]
      },
      {
        "id": 8,
        "title": "Binary Tree Maximum Path Sum",
        "languages": ["Java", "Python", "C"],
        "practiceLink": "https://leetcode.com/problems/binary-tree-maximum-path-sum/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png", "microsoft.png"]
      },
      {
        "id": 9,
        "title": "Vertical Order Traversal of a Binary Tree",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/vertical-order-traversal-of-a-binary-tree/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["amazon.jpeg", "microsoft.png"]
      },
      {
        "id": 10,
        "title": "Delete Node in a BST",
        "languages": ["C++", "Python", "Java"],
        "practiceLink": "https://leetcode.com/problems/delete-node-in-a-bst/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png", "amazon.jpeg"]
      },
      {
        "id": 11,
        "title": "Convert BST to Greater Tree",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/convert-bst-to-greater-tree/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png", "microsoft.png"]
      },
      {
        "id": 12,
        "title": "Binary Search Tree Iterator",
        "languages": ["Java", "Python", "C++"],
        "practiceLink": "https://leetcode.com/problems/binary-search-tree-iterator/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["amazon.jpeg", "Capgemini.png", "microsoft.png"]
      },
      {
        "id": 13,
        "title": "House Robber III",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/house-robber-iii/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png", "amazon.jpeg", "netflix.png"]
      },
      {
        "id": 14,
        "title": "Path Sum III",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/path-sum-iii/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["amazon.jpeg", "google.png", "microsoft.png"]
      },
      {
        "id": 15,
        "title": "Find Duplicate Subtrees",
        "languages": ["Java", "Python", "C++"],
        "practiceLink": "https://leetcode.com/problems/find-duplicate-subtrees/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png", "amazon.jpeg"]
      },
      {
        "id": 16,
        "title": "Trim a Binary Search Tree",
        "languages": ["Java", "Python", "C"],
        "practiceLink": "https://leetcode.com/problems/trim-a-binary-search-tree/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["microsoft.png", "amazon.jpeg"]
      },
      {
        "id": 17,
        "title": "Binary Tree Pruning",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/binary-tree-pruning/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png","amazon.jpeg"]
      },
      {
        "id": 18,
        "title": "Distribute Coins in Binary Tree",
        "languages": ["Java", "Python", "C++"],
        "practiceLink": "https://leetcode.com/problems/distribute-coins-in-binary-tree/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["amazon.jpeg", "microsoft.png"]
      },
      {
        "id": 19,
        "title": "All Nodes Distance K in Binary Tree",
        "languages": ["Java", "C++", "Python"],
        "practiceLink": "https://leetcode.com/problems/all-nodes-distance-k-in-binary-tree/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["google.png", "amazon.jpeg"]
      },
      {
        "id": 20,
        "title": "Flip Equivalent Binary Trees",
        "languages": ["Java", "Python", "C"],
        "practiceLink": "https://leetcode.com/problems/flip-equivalent-binary-trees/",
        "practiceSite": "leetcode.png",
        "status": "Untouched",
        "companies": ["microsoft.png", "google.png"]
      }
    ]
  };
  // Make sure this runs AFTER DOM is loaded
document.addEventListener("DOMContentLoaded", function () {
    // Initialize pagination and render first page
    renderPagination();
    goToPage(1);
    initializeTableFunctionality();
});

// Helper function to get paginated questions
function getPaginatedQuestions(pageNumber) {
    const questionsPerPage = 5;
    const startIndex = (pageNumber - 1) * questionsPerPage;
    const endIndex = startIndex + questionsPerPage;
    return data.questions.slice(startIndex, endIndex);
}

function renderTable(questions) {
    const tbody = document.querySelector('.table tbody');
    tbody.innerHTML = ''; // Clear existing rows

    questions.forEach((question, index) => {
        const row = document.createElement('tr');
        if (index % 2 === 1) row.style.backgroundColor = '#f9f9f9'; // Alternate row colors

        row.innerHTML =
            '<td style="width: 0px">' +
            '<div class="form-check">' +
            '<input class="form-check-input review-checkbox" type="checkbox" id="check-' + question.id + '">' +
            '<label class="form-check-label" for="check-' + question.id + '"></label>' +
            '</div>' +
            '</td>' +
            '<td>' +
            '<div class="d-flex align-items-center">' +
            '<div class="ms-4">' +
            '<div>' + question.title + '</div>' +
            '</div>' +
            '</div>' +
            '</td>' +
            '<td>' +
            '<div class="avatar-group">' +
            question.languages.map(function (lang) {
                return '<div class="avatar avatar-xs">' +
                    '<img class="avatar-img" src="' + lang.toLowerCase() + '.png" alt="' + lang + '">' +
                    '</div>';
            }).join('') +
            '</div>' +
            '</td>' +
            '<td>' +
            '<div class="avatar-group">' +
            '<div class="avatar avatar-xs" style="margin-left: 1.2vw;">' +
            '<a href="' + question.practiceLink + '">' +
            '<img class="avatar-img" src="' + question.practiceSite + '" alt="Practice site" style="' + (question.practiceSite === 'gfg.png' ? 'width: 39px; height: 23px;' : '') + '">' +
            '</a>' +
            '</div>' +
            '</div>' +
            '</td>' +
            '<td>' +
            '<select class="form-select form-select-sm border-0 status-select text-danger" style="width: auto;" data-review-link="' + question.practiceLink + '">' +
            '<option class="text-danger" value="Untouched"' + (question.status === 'Untouched' ? ' selected' : '') + '>Untouched</option>' +
            '<option class="text-warning" value="In Progress"' + (question.status === 'In Progress' ? ' selected' : '') + '>In Progress</option>' +
            '<option class="text-success" value="Completed"' + (question.status === 'Completed' ? ' selected' : '') + '>Completed</option>' +
            '<option class="text-primary" value="Review"' + (question.status === 'Review' ? ' selected' : '') + '>Review</option>' +
            '</select>' +
            '</td>' +
            '<td>' +
            '<div class="avatar-group">' +
            question.companies.map(function (company) {
                return '<div class="avatar avatar-xs">' +
                    '<img class="avatar-img" src="' + company + '" alt="' + company.split('.')[0] + '">' +
                    '</div>';
            }).join('') +
            '</div>' +
            '</td>';

        tbody.appendChild(row);
    });
}

function renderPagination() {
    const paginationContainer = document.querySelector('.pagination');
    const questionsPerPage = 5;
    const totalPages = Math.ceil(data.questions.length / questionsPerPage);

    paginationContainer.innerHTML = '';

    // Previous button
    const prevItem = document.createElement('li');
    prevItem.className = 'page-item';
    prevItem.innerHTML = `
        <a class="page-link" href="#" aria-label="Previous">
            <span aria-hidden="true">«</span>
        </a>
    `;
    prevItem.addEventListener('click', (e) => {
        e.preventDefault();
        const currentActive = document.querySelector('.pagination .active');
        const currentPage = currentActive ? parseInt(currentActive.textContent) : 1;
        if (currentPage > 1) {
            goToPage(currentPage - 1);
        }
    });
    paginationContainer.appendChild(prevItem);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = 'page-item';
        if (i === 1) pageItem.classList.add('active');

        const pageLink = document.createElement('a');
        pageLink.className = 'page-link';
        pageLink.href = '#';
        pageLink.textContent = i;

        pageLink.addEventListener('click', (e) => {
            e.preventDefault();
            goToPage(i);
        });

        pageItem.appendChild(pageLink);
        paginationContainer.appendChild(pageItem);
    }

    // Next button
    const nextItem = document.createElement('li');
    nextItem.className = 'page-item';
    nextItem.innerHTML = `
        <a class="page-link" href="#" aria-label="Next">
            <span aria-hidden="true">»</span>
        </a>
    `;
    nextItem.addEventListener('click', (e) => {
        e.preventDefault();
        const currentActive = document.querySelector('.pagination .active');
        const currentPage = currentActive ? parseInt(currentActive.textContent) : 1;
        if (currentPage < totalPages) {
            goToPage(currentPage + 1);
        }
    });
    paginationContainer.appendChild(nextItem);
}

function goToPage(pageNumber) {
    const questions = getPaginatedQuestions(pageNumber);
    renderTable(questions);
    updateActivePage(pageNumber);
    initializeTableFunctionality(); // Reinitialize functionality for new rows
}

function updateActivePage(newActivePage) {
    const pageItems = document.querySelectorAll('.pagination .page-item');
    pageItems.forEach((item, index) => {
        // Skip prev/next buttons (first and last elements)
        if (index > 0 && index < pageItems.length - 1) {
            item.classList.remove('active');
            if (index === newActivePage) {
                item.classList.add('active');
            }
        }
    });
}

function initializeTableFunctionality() {
    const completedCountElement = document.getElementById('completedCount');
    const searchInput = document.getElementById('questionSearch');

    function updateCompletedCount() {
        const statusDropdowns = document.querySelectorAll('.status-select');
        const completedCount = Array.from(statusDropdowns).filter(function (select) {
            return select.value === 'Completed';
        }).length;
        completedCountElement.textContent = completedCount + ' out of ' + statusDropdowns.length + ' programs completed';
    }

    function applyColorClass(select) {
        select.classList.remove('text-danger', 'text-warning', 'text-success', 'text-primary');
        switch (select.value) {
            case 'Untouched': select.classList.add('text-danger'); break;
            case 'In Progress': select.classList.add('text-warning'); break;
            case 'Completed': select.classList.add('text-success'); break;
            case 'Review': select.classList.add('text-primary'); break;
        }
    }

    function handleStatusChange(select, index) {
        const value = select.value;
        const checkboxes = document.querySelectorAll('.review-checkbox');
        const checkbox = checkboxes[index];

        checkbox.checked = (value === 'Completed' || value === 'Review');

        updateCompletedCount();
        applyColorClass(select);

        if (value === 'Review') {
            const reviewLink = select.getAttribute('data-review-link');
            if (reviewLink) window.open(reviewLink, '_blank');
        }
    }

    const statusDropdowns = document.querySelectorAll('.status-select');
    const checkboxes = document.querySelectorAll('.review-checkbox');
    statusDropdowns.forEach(function (select, index) {
        applyColorClass(select);
        if (select.value === 'Completed' || select.value === 'Review') checkboxes[index].checked = true;
        select.addEventListener('change', function () {
            handleStatusChange(select, index);
        });
    });

    updateCompletedCount();

    if (searchInput) {
        searchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('.table tbody tr');

            tableRows.forEach(function (row) {
                const questionCell = row.cells[1];
                const titleDiv = questionCell.querySelector('div.ms-4 > div');
                const questionText = titleDiv ? titleDiv.textContent.toLowerCase() : "";

                const statusSelect = row.querySelector('.status-select');
                const statusText = statusSelect ? statusSelect.value.toLowerCase() : "";

                const companyCell = row.cells[row.cells.length - 1];
                const companyImgs = companyCell ? companyCell.querySelectorAll('img') : [];
                let companyMatch = false;

                companyImgs.forEach(function (img) {
                    const src = img.getAttribute('src').toLowerCase();
                    if (src.includes(searchTerm)) companyMatch = true;
                });

                const matches = questionText.includes(searchTerm) || statusText.includes(searchTerm) || companyMatch;
                row.style.display = matches ? '' : 'none';
            });
        });
    }
}
  