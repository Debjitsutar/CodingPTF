// Top of JS file — Global data
const data = {
  "questions": [
    {
      "id": 1,
      "title": "Largest element in an array",
      "chapter": "Arrays",
      "subtopic": "Easy",
      "languages": ["Java", "C++", "Python", "C"],
      "practiceLink": "https://www.geeksforgeeks.org/problems/largest-element-in-array4009/0",
      "practiceSite": "gfg.png",
      "status": "Unattempted",
      "companies": ["tcs.jpg", "accenture.png"],
      "users": [["101","Attempted"], ["102","Unattempted"], ["103","Attempted"], ["104","Unattempted"], ["105","Attempted"]]
    },
    {
      "id": 2,
      "title": "Reverse a string",
      "chapter": "Strings",
      "subtopic": "Easy",
      "languages": ["Java", "Python", "C"],
      "practiceLink": "https://www.geeksforgeeks.org/write-a-c-program-to-reverse-a-string/",
      "practiceSite": "gfg.png",
      "status": "Completed",
      "companies": ["tcs.jpg"]
    },
    {
      "id": 3,
      "title": "Detect cycle in a graph",
      "chapter": "Graph",
      "subtopic": "Medium",
      "languages": ["C++", "Java", "Python"],
      "practiceLink": "https://leetcode.com/problems/course-schedule/",
      "practiceSite": "leetcode.png",
      "status": "Review",
      "companies": ["amazon.jpeg"]
    },
    {
      "id": 4,
      "title": "Inorder traversal of a binary tree",
      "chapter": "Trees",
      "subtopic": "Easy",
      "languages": ["Java", "Python", "C"],
      "practiceLink": "https://leetcode.com/problems/binary-tree-inorder-traversal/",
      "practiceSite": "leetcode.png",
      "status": "Attempted",
      "companies": ["google.png"]
    },
    {
      "id": 5,
      "title": "Longest common subsequence",
      "chapter": "Dynamic Programming",
      "subtopic": "Medium",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/longest-common-subsequence/",
      "practiceSite": "leetcode.png",
      "status": "Completed",
      "companies": ["microsoft.png"]
    },
    {
      "id": 6,
      "title": "Reverse a linked list",
      "chapter": "Linked List",
      "subtopic": "Easy",
      "languages": ["Java", "Python", "C"],
      "practiceLink": "https://leetcode.com/problems/reverse-linked-list/",
      "practiceSite": "leetcode.png",
      "status": "Attempted",
      "companies": ["amazon.jpeg"]
    },
    {
      "id": 7,
      "title": "Check for balanced parentheses",
      "chapter": "Strings",
      "subtopic": "Medium",
      "languages": ["C++", "Java", "Python"],
      "practiceLink": "https://leetcode.com/problems/valid-parentheses/",
      "practiceSite": "leetcode.png",
      "status": "Review",
      "companies": ["microsoft.png"]
    },
    {
      "id": 8,
      "title": "Topological Sort",
      "chapter": "Graph",
      "subtopic": "Hard",
      "languages": ["Java", "Python"],
      "practiceLink": "https://leetcode.com/problems/course-schedule-ii/",
      "practiceSite": "leetcode.png",
      "status": "Unattempted",
      "companies": ["google.png"]
    },
    {
      "id": 9,
      "title": "Height of a binary tree",
      "chapter": "Trees",
      "subtopic": "Medium",
      "languages": ["Java", "C++"],
      "practiceLink": "https://www.geeksforgeeks.org/write-a-c-program-to-find-the-height-or-depth-of-a-tree/",
      "practiceSite": "gfg.png",
      "status": "Attempted",
      "companies": ["accenture.png"]
    },
    {
      "id": 10,
      "title": "0/1 Knapsack",
      "chapter": "Dynamic Programming",
      "subtopic": "Hard",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://www.geeksforgeeks.org/0-1-knapsack-problem-dp-10/",
      "practiceSite": "gfg.png",
      "status": "Completed",
      "companies": ["google.png"]
    },
    {
      "id": 11,
      "title": "Detect loop in linked list",
      "chapter": "Linked List",
      "subtopic": "Medium",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://www.geeksforgeeks.org/detect-loop-in-a-linked-list/",
      "practiceSite": "gfg.png",
      "status": "Review",
      "companies": ["microsoft.png"]
    },
    {
      "id": 12,
      "title": "Kth largest element",
      "chapter": "Arrays",
      "subtopic": "Hard",
      "languages": ["Java", "C++"],
      "practiceLink": "https://leetcode.com/problems/kth-largest-element-in-an-array/",
      "practiceSite": "leetcode.png",
      "status": "Unattempted",
      "companies": ["amazon.jpeg"]
    },
    {
      "id": 13,
      "title": "Anagram check",
      "chapter": "Strings",
      "subtopic": "Easy",
      "languages": ["Python", "Java"],
      "practiceLink": "https://leetcode.com/problems/valid-anagram/",
      "practiceSite": "leetcode.png",
      "status": "Completed",
      "companies": ["accenture.png"]
    },
    {
      "id": 14,
      "title": "Find bridges in a graph",
      "chapter": "Graph",
      "subtopic": "Hard",
      "languages": ["C++", "Java"],
      "practiceLink": "https://www.geeksforgeeks.org/bridge-in-a-graph/",
      "practiceSite": "gfg.png",
      "status": "Attempted",
      "companies": ["google.png"]
    },
    {
      "id": 15,
      "title": "Lowest common ancestor",
      "chapter": "Trees",
      "subtopic": "Hard",
      "languages": ["Java", "Python"],
      "practiceLink": "https://leetcode.com/problems/lowest-common-ancestor-of-a-binary-tree/",
      "practiceSite": "leetcode.png",
      "status": "Completed",
      "companies": ["tcs.jpg"]
    },
    {
      "id": 16,
      "title": "Minimum number of coins",
      "chapter": "Dynamic Programming",
      "subtopic": "Medium",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://www.geeksforgeeks.org/find-minimum-number-of-coins-that-make-a-change/",
      "practiceSite": "gfg.png",
      "status": "Attempted",
      "companies": ["capgemini.jpg"]
    },
    {
      "id": 17,
      "title": "Add two numbers represented by linked list",
      "chapter": "Linked List",
      "subtopic": "Hard",
      "languages": ["Java", "Python"],
      "practiceLink": "https://leetcode.com/problems/add-two-numbers/",
      "practiceSite": "leetcode.png",
      "status": "Review",
      "companies": ["netflix.png"]
    },
    {
      "id": 18,
      "title": "Sort an array of 0s, 1s and 2s",
      "chapter": "Arrays",
      "subtopic": "Medium",
      "languages": ["C", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/sort-colors/",
      "practiceSite": "leetcode.png",
      "status": "Attempted",
      "companies": ["accenture.png"]
    },
    {
      "id": 19,
      "title": "Group anagrams",
      "chapter": "Strings",
      "subtopic": "Hard",
      "languages": ["Java", "C++", "Python"],
      "practiceLink": "https://leetcode.com/problems/group-anagrams/",
      "practiceSite": "leetcode.png",
      "status": "Review",
      "companies": ["google.png"]
    },
    {
      "id": 20,
      "title": "Detect and remove loop in linked list",
      "chapter": "Linked List",
      "subtopic": "Medium",
      "languages": ["Java", "Python"],
      "practiceLink": "https://www.geeksforgeeks.org/detect-and-remove-loop-in-a-linked-list/",
      "practiceSite": "gfg.png",
      "status": "Completed",
      "companies": ["tcs.jpg"]
    }
  ]
};

  // Make sure this runs AFTER DOM is loaded
document.addEventListener("DOMContentLoaded", function () {
    // Initialize pagination and render first page
    renderPagination();
    goToPage(1);
    initializeTableFunctionality();
});

// Helper function to get paginated questions
function getPaginatedQuestions(pageNumber) {
    const questionsPerPage = 5;
    const startIndex = (pageNumber - 1) * questionsPerPage;
    const endIndex = startIndex + questionsPerPage;
    return data.questions.slice(startIndex, endIndex);
}

function renderTable(questions) {
    const tbody = document.querySelector('.table tbody');
    tbody.innerHTML = ''; // Clear existing rows

    questions.forEach((question, index) => {
        const row = document.createElement('tr');
        if (index % 2 === 1) row.style.backgroundColor = '#f9f9f9'; // Alternate row colors

        row.innerHTML =
            '<td style="width: 0px">' +
            '<div class="form-check">' +
            '<input class="form-check-input review-checkbox" type="checkbox" id="check-' + question.id + '">' +
            '<label class="form-check-label" for="check-' + question.id + '"></label>' +
            '</div>' +
            '</td>' +
            '<td>' +
            '<div class="d-flex align-items-center">' +
            '<div class="ms-4">' +
            '<div>' + question.title + '</div>' +
            '</div>' +
            '</div>' +
            '</td>' +
            '<td>' +
            '<div class="avatar-group">' +
            question.languages.map(function (lang) {
                return '<div class="avatar avatar-xs">' +
                    '<img class="avatar-img" src="' + lang.toLowerCase() + '.png" alt="' + lang + '">' +
                    '</div>';
            }).join('') +
            '</div>' +
            '</td>' +
            '<td>' +
            '<div class="avatar-group">' +
            '<div class="avatar avatar-xs" style="margin-left: 1.2vw;">' +
            '<a href="' + question.practiceLink + '">' +
            '<img class="avatar-img" src="' + question.practiceSite + '" alt="Practice site" style="' + (question.practiceSite === 'gfg.png' ? 'width: 39px; height: 23px;' : '') + '">' +
            '</a>' +
            '</div>' +
            '</div>' +
            '</td>' +
            '<td>' +
            '<select class="form-select form-select-sm border-0 status-select text-danger" style="width: auto;" data-review-link="' + question.practiceLink + '">' +
            '<option class="text-danger" value="Untouched"' + (question.status === 'Untouched' ? ' selected' : '') + '>Untouched</option>' +
            '<option class="text-warning" value="In Progress"' + (question.status === 'In Progress' ? ' selected' : '') + '>In Progress</option>' +
            '<option class="text-success" value="Completed"' + (question.status === 'Completed' ? ' selected' : '') + '>Completed</option>' +
            '<option class="text-primary" value="Review"' + (question.status === 'Review' ? ' selected' : '') + '>Review</option>' +
            '</select>' +
            '</td>' +
            '<td>' +
            '<div class="avatar-group">' +
            question.companies.map(function (company) {
                return '<div class="avatar avatar-xs">' +
                    '<img class="avatar-img" src="' + company + '" alt="' + company.split('.')[0] + '">' +
                    '</div>';
            }).join('') +
            '</div>' +
            '</td>';

        tbody.appendChild(row);
    });
}

function renderPagination() {
    const paginationContainer = document.querySelector('.pagination');
    const questionsPerPage = 5;
    const totalPages = Math.ceil(data.questions.length / questionsPerPage);

    paginationContainer.innerHTML = '';

    // Previous button
    const prevItem = document.createElement('li');
    prevItem.className = 'page-item';
    prevItem.innerHTML = `
        <a class="page-link" href="#" aria-label="Previous">
            <span aria-hidden="true">«</span>
        </a>
    `;
    prevItem.addEventListener('click', (e) => {
        e.preventDefault();
        const currentActive = document.querySelector('.pagination .active');
        const currentPage = currentActive ? parseInt(currentActive.textContent) : 1;
        if (currentPage > 1) {
            goToPage(currentPage - 1);
        }
    });
    paginationContainer.appendChild(prevItem);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = 'page-item';
        if (i === 1) pageItem.classList.add('active');

        const pageLink = document.createElement('a');
        pageLink.className = 'page-link';
        pageLink.href = '#';
        pageLink.textContent = i;

        pageLink.addEventListener('click', (e) => {
            e.preventDefault();
            goToPage(i);
        });

        pageItem.appendChild(pageLink);
        paginationContainer.appendChild(pageItem);
    }

    // Next button
    const nextItem = document.createElement('li');
    nextItem.className = 'page-item';
    nextItem.innerHTML = `
        <a class="page-link" href="#" aria-label="Next">
            <span aria-hidden="true">»</span>
        </a>
    `;
    nextItem.addEventListener('click', (e) => {
        e.preventDefault();
        const currentActive = document.querySelector('.pagination .active');
        const currentPage = currentActive ? parseInt(currentActive.textContent) : 1;
        if (currentPage < totalPages) {
            goToPage(currentPage + 1);
        }
    });
    paginationContainer.appendChild(nextItem);
}

function goToPage(pageNumber) {
    const questions = getPaginatedQuestions(pageNumber);
    renderTable(questions);
    updateActivePage(pageNumber);
    initializeTableFunctionality(); // Reinitialize functionality for new rows
}

function updateActivePage(newActivePage) {
    const pageItems = document.querySelectorAll('.pagination .page-item');
    pageItems.forEach((item, index) => {
        // Skip prev/next buttons (first and last elements)
        if (index > 0 && index < pageItems.length - 1) {
            item.classList.remove('active');
            if (index === newActivePage) {
                item.classList.add('active');
            }
        }
    });
}

function initializeTableFunctionality() {
    const completedCountElement = document.getElementById('completedCount');
    const searchInput = document.getElementById('questionSearch');

    function updateCompletedCount() {
        const statusDropdowns = document.querySelectorAll('.status-select');
        const completedCount = Array.from(statusDropdowns).filter(function (select) {
            return select.value === 'Completed';
        }).length;
        completedCountElement.textContent = completedCount + ' out of ' + statusDropdowns.length + ' programs completed';
    }

    function applyColorClass(select) {
        select.classList.remove('text-danger', 'text-warning', 'text-success', 'text-primary');
        switch (select.value) {
            case 'Untouched': select.classList.add('text-danger'); break;
            case 'In Progress': select.classList.add('text-warning'); break;
            case 'Completed': select.classList.add('text-success'); break;
            case 'Review': select.classList.add('text-primary'); break;
        }
    }

    function handleStatusChange(select, index) {
        const value = select.value;
        const checkboxes = document.querySelectorAll('.review-checkbox');
        const checkbox = checkboxes[index];

        checkbox.checked = (value === 'Completed' || value === 'Review');

        updateCompletedCount();
        applyColorClass(select);

        if (value === 'Review') {
            const reviewLink = select.getAttribute('data-review-link');
            if (reviewLink) window.open(reviewLink, '_blank');
        }
    }

    const statusDropdowns = document.querySelectorAll('.status-select');
    const checkboxes = document.querySelectorAll('.review-checkbox');
    statusDropdowns.forEach(function (select, index) {
        applyColorClass(select);
        if (select.value === 'Completed' || select.value === 'Review') checkboxes[index].checked = true;
        select.addEventListener('change', function () {
            handleStatusChange(select, index);
        });
    });

    updateCompletedCount();

    if (searchInput) {
        searchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('.table tbody tr');

            tableRows.forEach(function (row) {
                const questionCell = row.cells[1];
                const titleDiv = questionCell.querySelector('div.ms-4 > div');
                const questionText = titleDiv ? titleDiv.textContent.toLowerCase() : "";

                const statusSelect = row.querySelector('.status-select');
                const statusText = statusSelect ? statusSelect.value.toLowerCase() : "";

                const companyCell = row.cells[row.cells.length - 1];
                const companyImgs = companyCell ? companyCell.querySelectorAll('img') : [];
                let companyMatch = false;

                companyImgs.forEach(function (img) {
                    const src = img.getAttribute('src').toLowerCase();
                    if (src.includes(searchTerm)) companyMatch = true;
                });

                const matches = questionText.includes(searchTerm) || statusText.includes(searchTerm) || companyMatch;
                row.style.display = matches ? '' : 'none';
            });
        });
    }
}
  